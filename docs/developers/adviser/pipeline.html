
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>State expansion pipeline &#8212; Thoth Adviser 0.52.3 documentation</title>
    <link rel="stylesheet" href="/assets/adviser/nameko.css" type="text/css" />
    <link rel="stylesheet" href="/assets/adviser/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="/assets/adviser/documentation_options.js"></script>
    <script type="text/javascript" src="/assets/adviser/jquery.js"></script>
    <script type="text/javascript" src="/assets/adviser/underscore.js"></script>
    <script type="text/javascript" src="/assets/adviser/doctools.js"></script>
    <script type="text/javascript" src="/assets/adviser/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Thoth’s resolver" href="resolver.html" />
    <link rel="prev" title="Configuring and setting up resolver in a cluster" href="deployment.html" />

   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Lora:400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resolver.html" title="Thoth’s resolver"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="deployment.html" title="Configuring and setting up resolver in a cluster"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Thoth Adviser 0.52.3 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="state-expansion-pipeline">
<span id="pipeline"></span><h1>State expansion pipeline<a class="headerlink" href="#state-expansion-pipeline" title="Permalink to this headline">¶</a></h1>
<p>In this section, one can find the developer’s introduction to state expansion
pipeline used in Thoth’s adviser that expands states to produce pipeline
products.</p>
<p>The pipeline is used to prepare, generate, filter and score partially or fully
resolved software stacks, abstracted into a <a class="reference internal" href="thoth.adviser.html#thoth.adviser.state.State" title="thoth.adviser.state.State"><code class="xref py py-class docutils literal notranslate"><span class="pre">State</span></code></a>.  The pipeline is run within <a class="reference internal" href="resolver.html#resolver"><span class="std std-ref">resolver</span></a> and can be triggered by two main methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.resolver.Resolver.resolve_products" title="thoth.adviser.resolver.Resolver.resolve_products"><code class="xref py py-func docutils literal notranslate"><span class="pre">Resolver.resolve_products</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.resolver.Resolver.resolve" title="thoth.adviser.resolver.Resolver.resolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">Resolver.resolve</span></code></a></p></li>
</ul>
<p>The first one is a lower level API for obtaining pipeline products that are
yielded during resolution. The latter one reports back a pipeline run
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.report.Report" title="thoth.adviser.report.Report"><code class="xref py py-class docutils literal notranslate"><span class="pre">Report</span></code></a> (and uses the first one under the
hood to obtain products). Note the latter one waits for the whole pipeline to
finish, whereas the first one yields products during run.</p>
<p>An example of a resolver run that runs the pipeline under the hood for
computing recommendations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">thoth.common</span> <span class="kn">import</span> <span class="n">RuntimeEnvironment</span>
<span class="kn">from</span> <span class="nn">thoth.adviser</span> <span class="kn">import</span> <span class="n">Resolver</span>
<span class="kn">from</span> <span class="nn">thoth.adviser.enums</span> <span class="kn">import</span> <span class="n">RecommendationType</span>
<span class="kn">from</span> <span class="nn">thoth.adviser.predictors</span> <span class="kn">import</span> <span class="n">AdaptiveSimulatedAnnealing</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="kn">import</span> <span class="n">Project</span>

<span class="n">runtime_environment</span> <span class="o">=</span> <span class="n">RuntimeEnvironment</span><span class="p">()</span>
<span class="n">runtime_environment</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fedora&quot;</span>
<span class="n">runtime_environment</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;31&quot;</span>
<span class="n">runtime_environment</span><span class="o">.</span><span class="n">python_version</span> <span class="o">=</span> <span class="s2">&quot;3.7&quot;</span>
<span class="n">runtime_environment</span><span class="o">.</span><span class="n">cuda_version</span> <span class="o">=</span> <span class="s2">&quot;9.0&quot;</span>
<span class="n">runtime_environment</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">cpu_model</span> <span class="o">=</span> <span class="mi">142</span>

<span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span>
    <span class="n">pipfile_path</span><span class="o">=</span><span class="s2">&quot;./Pipfile&quot;</span><span class="p">,</span>
    <span class="n">runtime_environment</span><span class="o">=</span><span class="n">runtime_environment</span>
<span class="p">)</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="o">.</span><span class="n">get_adviser_instance</span><span class="p">(</span>
    <span class="n">beam_width</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">library_usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">limit_latest_versions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">AdaptiveSimulatedAnnealing</span><span class="p">(),</span>
    <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
    <span class="n">recommendation_type</span><span class="o">=</span><span class="n">RecommendationType</span><span class="o">.</span><span class="n">LATEST</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">report</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">with_devel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</pre></div>
</div>
<p>As you can see above, the resolver has quite a few arguments to be passed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">beam_width</span></code> - limitation for state space that should be taken into account during a resolver run (see beam section bellow for more info)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">count</span></code> - number of software stacks reported back by the resolver</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">library_usage</span></code> - static source code analysis as done by <a class="reference external" href="https://github.com/thoth-station/invectio">Thoth’s Invectio</a> - this library usage states libraries and symbols used from these libraries that can help with application specific recommendations (e.g. recommending different versions of TensorFlow for applications using convolutional layers)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">limit</span></code> - number of software stacks (final states) scored in total - resolver is stopped once this limit is reached or there are no more states in the beam to be resolved</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">limit_latest_versions</span></code> - limit number of latest versions for all the packages in the dependency graph considered during resolution to reduce state space considered</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">predictor</span></code> - an implementation of <a class="reference internal" href="thoth.adviser.html#thoth.adviser.predictor.Predictor" title="thoth.adviser.predictor.Predictor"><code class="xref py py-class docutils literal notranslate"><span class="pre">Predictor</span></code></a> to be used together with resolver to resolve software stacks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project</span></code> - instance of <code class="docutils literal notranslate"><span class="pre">Project</span></code> available in <code class="docutils literal notranslate"><span class="pre">thoth-python</span></code> library that provides direct dependencies and information about runtime environment used to run and build the application</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recommendation_type</span></code> - type of targeted recommendations - see <a class="reference internal" href="thoth.adviser.html#thoth.adviser.enums.RecommendationType" title="thoth.adviser.enums.RecommendationType"><code class="xref py py-class docutils literal notranslate"><span class="pre">RecommendationType</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prescription</span></code> - instance of <code class="docutils literal notranslate"><span class="pre">Prescription</span></code> stating loaded prescriptions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cli_parameters</span></code> - parameters passed in based on CLI invocation</p></li>
</ul>
<p>A similar method, <a class="reference internal" href="thoth.adviser.html#thoth.adviser.resolver.Resolver.get_dependency_monkey_instance" title="thoth.adviser.resolver.Resolver.get_dependency_monkey_instance"><code class="xref py py-func docutils literal notranslate"><span class="pre">Resolver.get_dependency_monkey_instance</span></code></a> obtains
resolver for a <a class="reference internal" href="dependency_monkey.html#dependency-monkey"><span class="std std-ref">Dependency Monkey run</span></a>. When creating
a Dependency Monkey resolver, resolver asks for <a class="reference internal" href="thoth.adviser.html#thoth.adviser.enums.DecisionType" title="thoth.adviser.enums.DecisionType"><code class="xref py py-class docutils literal notranslate"><span class="pre">DecisionType</span></code></a> instead of <a class="reference internal" href="thoth.adviser.html#thoth.adviser.enums.RecommendationType" title="thoth.adviser.enums.RecommendationType"><code class="xref py py-class docutils literal notranslate"><span class="pre">RecommendationType</span></code></a>.</p>
<p>As you can see, there is no pipeline configuration passed to the resolver
instance. In such cases, resolver iterates over shipped pipeline units
available and tries to create a pipeline configuration that is suitable for the
given set of parameters - see <a class="reference internal" href="thoth.adviser.html#thoth.adviser.unit.Unit.should_include" title="thoth.adviser.unit.Unit.should_include"><code class="xref py py-func docutils literal notranslate"><span class="pre">Unit.should_include</span></code></a> method and <a class="reference internal" href="unit.html#unit"><span class="std std-ref">unit documentation</span></a> on information how to let pipeline units be included in a certain
resolver run. In other words, the pipeline configuration is dynamically
created based on resolver’s input parameters and hyperparameters.</p>
<p>If you would like to provide your own pipeline configuration, you can do so by
explicitly passing <code class="docutils literal notranslate"><span class="pre">pipeline_config</span></code> argument which states a dictionary
representation of a pipeline configuration or directly instance of
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_config.PipelineConfig" title="thoth.adviser.pipeline_config.PipelineConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineConfig</span></code></a> with all
the pipeline units instantiated and configured.</p>
<p>See <a class="reference external" href="https://github.com/thoth-station/notebooks/blob/master/notebooks/development/Pipeline%20units.ipynb">this Jupyter Notebook</a>
that demonstrates how pipeline is constructed and how the resolution process
uses it to resolve software stacks meeting the desired quality.</p>
<section id="pipeline-and-resolver-execution">
<h2>Pipeline and resolver execution<a class="headerlink" href="#pipeline-and-resolver-execution" title="Permalink to this headline">¶</a></h2>
<p>Before any resolution, resolver calls <a class="reference internal" href="thoth.adviser.html#thoth.adviser.unit.Unit.pre_run" title="thoth.adviser.unit.Unit.pre_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">Unit.pre_run</span></code></a> method that can be used in any pipeline unit
implementation to signalize a new resolution. It’s a good practice to set any
initialization here as pipeline units are instantiated once per resolver. If
there are run multiple resolutions for the same resolver instance, the pipeline
unit instances will be shared.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://github.com/thoth-station/notebooks/blob/master/notebooks/development/Gradient-free%20reinforcement%20learning%20predictors.ipynb">Check the linked Jupyter Notebook</a>
if you wish to dive into sources.</p>
</div>
<p>All pipeline units are grouped based on their type in the
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_config.PipelineConfig" title="thoth.adviser.pipeline_config.PipelineConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineConfig</span></code></a> and
resolver runs with respect to their relative ordering when pipeline units are executed.
Pipeline units specific for a certain packages are prioritized in oposite to
the generic ones - see <span class="xref std std-ref">the units section for more info</span>.</p>
<p>The very first pipeline units triggered are pipeline units of type <a class="reference internal" href="thoth.adviser.html#thoth.adviser.boot.Boot" title="thoth.adviser.boot.Boot"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boot</span></code></a>. They are triggered prior to any resolution done -
see <a class="reference internal" href="boots.html#boots"><span class="std std-ref">boot unit documentation for more info</span></a>.</p>
<p>Once all <a class="reference internal" href="thoth.adviser.html#thoth.adviser.boot.Boot" title="thoth.adviser.boot.Boot"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boot</span></code></a> units are successfully
executed, resolver resolves all the direct dependencies (that are sorted and
filtered out based on <code class="docutils literal notranslate"><span class="pre">limit_latest_versions</span></code> configuration option) of the
application and executes pipeline units of type <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pseudonym.Pseudonym" title="thoth.adviser.pseudonym.Pseudonym"><code class="xref py py-class docutils literal notranslate"><span class="pre">Pseudonym</span></code></a> to compute “pseudonyms” for packages
(packages providing same functionality but have different name or different
version identifier). See <a class="reference internal" href="pseudonyms.html#pseudonyms"><span class="std std-ref">pseudonyms section for more info</span></a>.</p>
<p>The next pipeline units of type <a class="reference internal" href="thoth.adviser.html#thoth.adviser.sieve.Sieve" title="thoth.adviser.sieve.Sieve"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sieve</span></code></a>
filter out packages that should not be considered during resolver run. See
<a class="reference internal" href="sieves.html#sieves"><span class="std std-ref">sieve pipeline unit documentation for more information</span></a>.</p>
<p>Once sieves filter out packages in unwanted versions, resolver creates initial
states that are formed out of all the combinations of packages in different
versions that can occur in a software stack considering also pseydonyms
computed. As packages in different versions are sorted based on their version
string semantics, the very first combination has always the latest versions of
all the packages (this fact is used for example in hill climbing or in the
<a class="reference internal" href="predictors/annealing.html#annealing"><span class="std std-ref">adaptive simulated annealing approach</span></a>).  For each newly
created initial state, there are run <a class="reference internal" href="steps.html#steps"><span class="std std-ref">pipeline steps</span></a> that decide
whether inclusion of a package version is valid to a state and if so, what is
the quality of such a resolution step - this is done for each and every
package-version combination.</p>
<p>If all the steps on a state accept the given package, a newly created state
(this <a class="reference internal" href="introduction.html#introduction-rl"><span class="std std-ref">corresponds to taking an action from a state to a new state in a Markov
Decision Process</span></a>) is added to the resolver beam as a state
to be considered during resolver run, respecting <a class="reference internal" href="deployment.html#beam-width"><span class="std std-ref">beam width parameter</span></a>.</p>
<p>The resolver then picks a state stored in the beam based on
<a class="reference internal" href="predictor.html#predictor"><span class="std std-ref">predictor’s decision</span></a> and resolves not yet resolved
dependencies in the state. The resolution of a dependency makes a dependency
resolved and all its dependencies, if any, unresolved. Resolver, again,
runs all the sieves and pseudonyms on the newly introduced dependencies into
the state and pipeline steps to verify and score the given resolver step.</p>
<p>A state is considered as a final if there are no more unresolved dependencies.
Such state is then passed to all <a class="reference internal" href="strides.html#strides"><span class="std std-ref">pipeline strides</span></a> that decide
whether the final state should become a pipeline product or not. Once it is
accepted all pipeline units of type <a class="reference internal" href="wraps.html#wraps"><span class="std std-ref">wrap</span></a> are called to wrap up
the resolution of the final state. After all, state is converted into a
pipeline product and yielded, possibly becoming part of a pipeline report, if
requested so.</p>
</section>
<section id="context-and-beam">
<h2>Context and Beam<a class="headerlink" href="#context-and-beam" title="Permalink to this headline">¶</a></h2>
<p>There are three main abstractions that are fundamental when creating any
pipeline unit or predictor for Thoth’s adviser:</p>
<ul class="simple">
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.context.Context" title="thoth.adviser.context.Context"><code class="xref py py-class docutils literal notranslate"><span class="pre">Context</span></code></a> - context carried during the whole resolver run; states all the necessary information for pipeline units and for predictor</p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilderContext" title="thoth.adviser.pipeline_builder.PipelineBuilderContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilderContext</span></code></a> - context used during pipeline creation by <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilder" title="thoth.adviser.pipeline_builder.PipelineBuilder"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilder</span></code></a> if pipeline configuration was not explicitly provided - see <a class="reference internal" href="unit.html#unit"><span class="std std-ref">unit section for more information</span></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.beam.Beam" title="thoth.adviser.beam.Beam"><code class="xref py py-class docutils literal notranslate"><span class="pre">Beam</span></code></a> - simply, <a class="reference external" href="https://en.wikipedia.org/wiki/Beam_search">beam</a>, a pool of states kept</p></li>
</ul>
<p>Beam is an abstract data type maintained by resolver that keeps track of pool
of states that are about to be (possibly) resolved. This pool can have
<a class="reference internal" href="deployment.html#beam-width"><span class="std std-ref">restricted width</span></a> which limits the number of states
kept in memory and limits number of states considered during resolution.</p>
<p>It’s possible to request a history plot for the beam size and the highest rated
stack score for introspection purposes using the <code class="docutils literal notranslate"><span class="pre">--plot</span></code> option or by
calling <a class="reference internal" href="thoth.adviser.html#thoth.adviser.beam.Beam.plot" title="thoth.adviser.beam.Beam.plot"><code class="xref py py-func docutils literal notranslate"><span class="pre">Beam.plot</span></code></a>. The figure below
shows beam history during resolution of 1000 TensorFlow software stacks by
sampling the state space using <a class="reference internal" href="predictors/annealing.html#annealing"><span class="std std-ref">adaptive simulated annealing</span></a>.
CVE penalization was the only <a class="reference internal" href="steps.html#steps"><span class="std std-ref">pipeline step</span></a> used during
the resolution process, resolver did approximately 2500 resolution rounds to
score 1000 software stacks (<code class="docutils literal notranslate"><span class="pre">limit</span></code> parameter to adviser).</p>
<a class="reference external image-reference" href="/assets/adviser/beam_history_plot.png"><img alt="Plotted history of beam size during TensorFlow stacks resolution." src="/assets/beam_history_plot.png" /></a>
<p>As can be seen, the beam limited number of states taken into consideration
until approximately 18000th round. After this round, the temperature in the
<a class="reference internal" href="predictors/annealing.html#annealing"><span class="std std-ref">adaptive simulated annealing</span></a> started to drop so resolver
ended up expanding just the top rated state based on <a class="reference internal" href="predictors/annealing.html#annealing"><span class="std std-ref">adaptive simulated
annealing</span></a> predictor output (so stack resolution pipeline started
to produce more products - resolved software stacks - and reduced production
of non-final states).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s good to find the right balance for the beam width. A beam that is too
small restricts the state space too much which can cause that no software
stack is resolved. Too big beam can lead to a very large state space to be
explored and consumption of too much CPU time (and actual time) to produce
software stacks. See <a class="reference internal" href="deployment.html#beam-width"><span class="std std-ref">the section discussion beam width</span></a>.</p>
</div>
</section>
<section id="id1">
<h2>Pipeline configuration creation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Each pipeline unit provides a class method called <code class="docutils literal notranslate"><span class="pre">should_include</span></code> which is
executed on the <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_config.PipelineConfig" title="thoth.adviser.pipeline_config.PipelineConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">pipeline</span> <span class="pre">configuration</span> <span class="pre">creation</span></code></a> (that states a list of boots,
pseudonyms, sieves, steps, strides and wraps to be included in the pipeline).
Similarly, prescription pipeline units provide <code class="docutils literal notranslate"><span class="pre">should_include</span></code> directive
that is mapped to <code class="docutils literal notranslate"><span class="pre">should_include</span></code> class method under the hood.  The class
method returns a dictionary stating unit configuration if the given unit should
be used (an empty dictionary if no configuration changes to the default unit
configuration are done), a special value of <code class="docutils literal notranslate"><span class="pre">None</span></code> indicates the given
pipeline unit should not be added to the pipeline configuration.</p>
<a class="reference external image-reference" href="/assets/adviser/pipeline_builder.gif"><img alt="Pipeline builder building the pipeline configuration." src="/assets/pipeline_builder.gif" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">should_include</span></code> unit class method is in fact called multiple times during
the pipeline configuration construction. The pipeline builder iterates over all
the pipeline units available in adviser implementation and asks if they
should be included in the pipeline configuration until no change to the
pipeline configuration is made. This way pipeline can be constructed
autonomously where a developer of a pipeline unit just programatically states
when the given pipeline unit should be included in the pipeline configuration
(stating dependencies on other pipeline units or conditionally add pipeline
unit under specific circumferences and runtime environment configuration). An
example can be a pipeline unit which includes scoring based on performance
indicators done on <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/nn/conv2d">conv2d</a> used in a
TensorFlow application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># snip ...</span>

<span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">PipelineBuilderContext</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Include this pipeline unit if user uses TensorFlow and there are done calls to conv2d.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
       <span class="c1"># This pipeline unit is already included in the pipeline configuration, we don&#39;t</span>
       <span class="c1"># need to include this pipeline unit multiple times.</span>
       <span class="c1">#</span>
       <span class="c1"># The same method `is_included&#39; can be used to inspect if pre-requisite pipeline</span>
       <span class="c1"># units are present in the pipeline configuration.</span>
       <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">library_usage</span> <span class="ow">and</span> <span class="s2">&quot;tensorflow.nn.conv2d&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">library_usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">,</span> <span class="p">{}):</span>
       <span class="c1"># As an example - adjust parameter `score_factor&#39; of this pipeline</span>
       <span class="c1"># unit to 2.0, which will override the default one.</span>
       <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;score_factor&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

<span class="c1"># ... snip</span>
</pre></div>
</div>
<p>Each unit type respects relative ordering and units are grouped based on their
type - for example the very first sieve added is run first, then a second one
and so on respecting the relative order of sieves in the pipeline configuration
(the order in which they were included). This logic applies to all pipeline
unit types - <a class="reference internal" href="boots.html#boots"><span class="std std-ref">boots</span></a>, <a class="reference internal" href="pseudonyms.html#pseudonyms"><span class="std std-ref">pseudonymns</span></a>,
<a class="reference internal" href="sieves.html#sieves"><span class="std std-ref">sieves</span></a>, <a class="reference internal" href="steps.html#steps"><span class="std std-ref">steps</span></a>, <a class="reference internal" href="strides.html#strides"><span class="std std-ref">strides</span></a> and
<a class="reference internal" href="wraps.html#wraps"><span class="std std-ref">wraps</span></a>. In case of prescription pipeline units, use
<code class="docutils literal notranslate"><span class="pre">should_include.dependencies</span></code> to respect dependencies on other units. See
<a class="reference internal" href="prescription/should_include.html#prescription-should-include"><span class="std std-ref">relevant documentation for more info</span></a>.</p>
<p>Moreover, pipeline units can be specific to a package. This was introduced as
an optimization to group pipeline units based on packages they operate on
not to call them ineffectively on packages that are not relevant in the
resolution process.  Note pipeline units can be called thousand times during
the resolution process so this optimization matters a lot.</p>
<p>See implementation of <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilderContext" title="thoth.adviser.pipeline_builder.PipelineBuilderContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilderContext</span></code></a> for more info on
provided methods that can be used during pipeline configuration creation.</p>
<p>Note the resolution algorithm with pipeline units is shared for computing
advises and for Dependency Monkey to test and evaluate characteristics of
software stacks. You can use methods provided by <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilderContext" title="thoth.adviser.pipeline_builder.PipelineBuilderContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilderContext</span></code></a> to check if the
pipeline configuration is created for computing advises or whether the created
pipeline configuration is used in Dependency Monkey runs.</p>
</section>
<section id="instrumentation-of-resolver-s-pipeline-units">
<h2>Instrumentation of resolver’s pipeline units<a class="headerlink" href="#instrumentation-of-resolver-s-pipeline-units" title="Permalink to this headline">¶</a></h2>
<p>Besides letting pipeline units to autonomously register into the pipeline
configuration, the pipeline configuration can be supplied also explicitly. This
is useful for instrumenting resolver during <a class="reference internal" href="dependency_monkey.html#dependency-monkey"><span class="std std-ref">Dependency Monkey</span></a> runs or when experimenting/debugging the resolution
pipeline. In that case, the <a class="reference internal" href="thoth.adviser.html#thoth.adviser.unit.Unit.should_include" title="thoth.adviser.unit.Unit.should_include"><code class="xref py py-func docutils literal notranslate"><span class="pre">Unit.should_include</span></code></a> method is never called and the
configuration of the pipeline is explicitly encoded in a JSON format:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;pipeline&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;boots&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;sieves&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CutPreReleasesSieve&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PackageIndexSieve&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;without_error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SolvedSieve&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;cve_penalization&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.2</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CvePenalizationStep&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;strides&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;wraps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Each unit is referenced by its class name and is included from the
thoth-adviser’s implementation (modules <a class="reference internal" href="thoth.adviser.boots.html#module-thoth.adviser.boots" title="thoth.adviser.boots"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.boots</span></code></a>,
<a class="reference internal" href="thoth.adviser.pseudonyms.html#module-thoth.adviser.pseudonyms" title="thoth.adviser.pseudonyms"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.pseudonyms</span></code></a>, <a class="reference internal" href="thoth.adviser.sieves.html#module-thoth.adviser.sieves" title="thoth.adviser.sieves"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.sieves</span></code></a>,
<a class="reference internal" href="thoth.adviser.steps.html#module-thoth.adviser.steps" title="thoth.adviser.steps"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.steps</span></code></a>, <a class="reference internal" href="thoth.adviser.strides.html#module-thoth.adviser.strides" title="thoth.adviser.strides"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.strides</span></code></a> and
<a class="reference internal" href="thoth.adviser.wraps.html#module-thoth.adviser.wraps" title="thoth.adviser.wraps"><code class="xref py py-mod docutils literal notranslate"><span class="pre">thoth.adviser.wraps</span></code></a>). The configuration is used to adjust unit’s
configuration - see <a class="reference internal" href="unit.html#unit"><span class="std std-ref">unit documentation section for more info</span></a>.</p>
<p>This configuration can be supplied to adviser as well as to Dependency Monkey
via CLI or in the resolver constructor when resolver is created
programmatically.</p>
</section>
<section id="prescription-pipeline-units">
<h2>Prescription pipeline units<a class="headerlink" href="#prescription-pipeline-units" title="Permalink to this headline">¶</a></h2>
<p>The resolver implementation has an interface to supply pipeline units specified
using a YAML file (declarative syntax). Check <a class="reference internal" href="prescription.html#prescription"><span class="std std-ref">prescription section</span></a> for more info.</p>
</section>
<section id="static-source-code-analysis-library-usage">
<h2>Static source code analysis - library usage<a class="headerlink" href="#static-source-code-analysis-library-usage" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="integration.html#integration"><span class="std std-ref">Integrations with Thoth</span></a> (such as <a class="reference external" href="https://thoth-station.ninja/docs/developers/thamos">Thamos</a>) can use static source
code analysis on the client side when asking for advises. In that case, sources
are scanned for library imports and library symbols usage (<a class="reference external" href="https://github.com/thoth-station/invectio">Invectio</a> is used).  The gathered library
usage captures libraries and what symbols are used from these libraries in
sources. This information can be subsequently used in recommendations (in the
state generation pipeline) to target recommendations specific to user’s
application.</p>
</section>
<section id="a-note-to-hardware-environment">
<h2>A note to hardware environment<a class="headerlink" href="#a-note-to-hardware-environment" title="Permalink to this headline">¶</a></h2>
<p>Hardware environment is stating what hardware is present to run the given
application. <a class="reference external" href="https://thoth-station.ninja/docs/developers/thamos">Thamos</a> is
capable to perform hardware discovery as well (besides software environment
discovery). An example of hardware environment configuration can be GPU or CPU
type. Any request done to Thoth backend automatically carries the hardware
information that is detected if <a class="reference internal" href="integration.html#integration"><span class="std std-ref">Thoth’s official integration tools were
used</span></a>.</p>
</section>
</section>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">State expansion pipeline</a><ul>
<li><a class="reference internal" href="#pipeline-and-resolver-execution">Pipeline and resolver execution</a></li>
<li><a class="reference internal" href="#context-and-beam">Context and Beam</a></li>
<li><a class="reference internal" href="#id1">Pipeline configuration creation</a></li>
<li><a class="reference internal" href="#instrumentation-of-resolver-s-pipeline-units">Instrumentation of resolver’s pipeline units</a></li>
<li><a class="reference internal" href="#prescription-pipeline-units">Prescription pipeline units</a></li>
<li><a class="reference internal" href="#static-source-code-analysis-library-usage">Static source code analysis - library usage</a></li>
<li><a class="reference internal" href="#a-note-to-hardware-environment">A note to hardware environment</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation index</a><ul>
      <li>Previous: <a href="deployment.html" title="previous chapter">Configuring and setting up resolver in a cluster</a></li>
      <li>Next: <a href="resolver.html" title="next chapter">Thoth’s resolver</a></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="sources/pipeline.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

  
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>